<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.pms.survey.dao.SurveyQuestionDao">

  	<resultMap type="com.ktdsuniversity.edu.pms.survey.vo.SurveyQuestionVO" 
  	           id="SurveyQuestionVOMap"
  	           autoMapping="true">
		<id column="SRV_ID" property="srvId" />
		<association property="projectVO"
					 javaType="com.ktdsuniversity.edu.pms.project.vo.ProjectVO">
			<id column="PRJ_ID" property="prjId" />
			<result column="PRJ_NAME" property="prjName" />
			<result column="CLNT_INFO" property="clntInfo" />
			<result column="DEPT_ID" property="deptId" />
			<result column="PRJ_STS" property="prjSts" />
			<result column="STRT_DT" property="strtDt" />
			<result column="END_DT" property="endDt" />
		</association>
		<association property="projectTeammateVO"
					 javaType="com.ktdsuniversity.edu.pms.project.vo.ProjectTeammateVO">
			<id column="PRJ_TM_ID" property="prjTmId" />
			<result column="TM_ID" property="tmId" />
			<result column="ROLE" property="role" />
		</association>
		<association property="departmentVO"
					 javaType="com.ktdsuniversity.edu.pms.department.vo.DepartmentVO">
			<id column="DEPT_ID" property="deptId" />
			<result column="DEPT_NAME" property="deptName" />
		</association>
		<association property="employeeVO"
					 javaType="com.ktdsuniversity.edu.pms.employee.vo.EmployeeVO">
			<id column="EMP_ID" property="empId" />
			<result column="EMP_NAME" property="empName" />
		</association>
	</resultMap>

	<select id="getAllSurvey" resultMap="SurveyQuestionVOMap">
		SELECT DISTINCT sq.PRJ_ID
			 , sq.SRV_STS
			 , p.PRJ_NAME
			 , p.CLNT_INFO
			 , p.DEPT_ID
			 , p.PRJ_STS
			 , TO_CHAR(p.STRT_DT, 'YYYY/MM/DD') STRT_DT
			 , TO_CHAR(p.END_DT, 'YYYY/MM/DD') END_DT
			 , d.DEPT_NAME
		  FROM SURVEY_QUESTION sq
		  JOIN PROJECT p
		    ON p.PRJ_ID = sq.PRJ_ID
		  JOIN DEPARTMENT d
    		ON d.DEPT_ID = p.DEPT_ID
		 WHERE p.DEL_YN = 'N'
	</select>
	
	<select id="selectOneSurvey" parameterType="String" resultMap="SurveyQuestionVOMap">
		SELECT sq.SRV_ID
			 , sq.PRJ_ID
			 , sq.SRV_QST
			 , sq.CRTR_ID
			 , sq.CRT_DT
			 , sq.MDFR_ID
			 , sq.MDF_DT
			 , sq.DEL_YN
			 , sq.SEQ
			 , sq.TYPE_YN
			 , sq.SRV_STS
			 , p.PRJ_NAME
			 , d.DEPT_NAME
			 , pt.TM_ID
			 , pt.ROLE
			 , e.EMP_NAME
		  FROM (SELECT SRV_ID
		  			 , PRJ_ID
		  			 , SRV_QST
		  			 , CRTR_ID
		  			 , CRT_DT
		  			 , MDFR_ID
		  			 , MDF_DT
		  			 , DEL_YN
		  			 , SEQ
		  			 , TYPE_YN
		  			 , SRV_STS
		  		  FROM SURVEY_QUESTION) sq
		  JOIN PROJECT p
		    ON p.PRJ_ID = sq.PRJ_ID
		  JOIN DEPARTMENT d
		    ON d.DEPT_ID = p.DEPT_ID
		  JOIN PROJECT_TEAMMATE pt
		    ON pt.PRJ_ID = p.PRJ_ID
		  JOIN EMPLOYEE e
		    ON e.EMP_ID = pt.TM_ID
		 WHERE sq.PRJ_ID = #{_parameter}
		   AND pt.ROLE = 'PM'
		   AND ROWNUM = 1
		   AND sq.DEL_YN = 'N'
	</select>
	
	<insert id="insertNewSurveyQuestion" parameterType="com.ktdsuniversity.edu.pms.survey.vo.SurveyQuestionVO">
	
		<selectKey keyProperty="srvId" order="BEFORE" resultType="string">
			SELECT 'SRV_QST_' || TO_CHAR(SYSDATE, 'YYMMDD') || '_' || LPAD(SEQ_SURVEY_QUESTION_PK.NEXTVAL, 6, '0')
			  FROM DUAL
		</selectKey>
	
		INSERT INTO SURVEY_QUESTION
		 (SRV_ID
		, PRJ_ID
		, SRV_QST
		, CRTR_ID
		, CRT_DT
		, MDFR_ID
		, MDF_DT
		, DEL_YN
		, SEQ
		, TYPE_YN
		, SRV_STS)
		VALUES
		 (#{srvId}
		, #{prjId}
		, ' '
		, #{crtrId}
		, SYSDATE
		, NULL
		, NULL
		, 'N'
		, #{seq}
		, #{typeYn}
		, 'W')
	</insert>
	
	<select id="getOneSurvey" parameterType="String" resultMap="SurveyQuestionVOMap">
		SELECT SRV_ID
			 , PRJ_ID
			 , SRV_QST
			 , CRTR_ID
			 , TO_CHAR(CRT_DT, 'YYYY/MM/DD') CRT_DT
			 , MDFR_ID
			 , TO_CHAR(MDF_DT, 'YYYY/MM/DD') MDF_DT
			 , DEL_YN
			 , SEQ
			 , TYPE_YN
			 , SRV_STS
		  FROM SURVEY_QUESTION
		 WHERE DEL_YN = 'N'
		   AND SRV_ID = #{_parameter}
	</select>
	
	<update id="insertSurveyBody" parameterType="com.ktdsuniversity.edu.pms.survey.vo.SurveyQuestionVO">
		UPDATE SURVEY_QUESTION
		   SET SRV_QST = #{srvQst}
		     , TYPE_YN = #{typeYn}
		     , SRV_STS = 'Y'
		 WHERE SRV_ID = #{srvId}
	</update>
	
	<update id="modifyOneSurvey" parameterType="com.ktdsuniversity.edu.pms.survey.vo.SurveyQuestionVO">
		UPDATE SURVEY_QUESTION
		   SET SRV_QST = #{srvQst}
		     , MDFR_ID = #{mdfrId}
		     , MDF_DT = SYSDATE
		     , SEQ = #{seq}
		     , TYPE_YN = #{typeYn}
		 WHERE SRV_ID = #{srvId}
	</update>
	
	<update id="modifyOneSurveyExceptBody" parameterType="com.ktdsuniversity.edu.pms.survey.vo.SurveyQuestionVO">
		UPDATE SURVEY_QUESTION
		   SET SEQ = #{seq}
		     , TYPE_YN = #{typeYn}
		 WHERE SRV_ID = #{srvId}
	</update>
	
	<select id="getAllSurveys" parameterType="com.ktdsuniversity.edu.pms.survey.vo.SearchSurveyVO"
			resultMap="SurveyQuestionVOMap">
		SELECT sq.SRV_ID
			 , sq.PRJ_ID
			 , sq.SRV_QST
			 , sq.CRTR_ID
			 , sq.CRT_DT
			 , sq.MDFR_ID
			 , sq.MDF_DT
			 , sq.DEL_YN
			 , sq.SEQ
			 , sq.TYPE_YN
			 , sq.SRV_STS
			 , sqp.SQP_ID
			 , sqp.SQP_CNTNT
			 , sqp.NEXT_ID
			 , sqp.CRTR_ID
			 , sqp.CRT_DT
			 , sqp.MDFR_ID
			 , sqp.MDF_DT
			 , sqp.DEL_YN
			 , sqp.SEQ
		  FROM SURVEY_QUESTION sq
		  JOIN SURVEY_QUESTION_PICK sqp
		    ON sqp.SRV_ID = sq.SRV_ID
		 WHERE sq.PRJ_ID = #{prjId}
		   AND sq.DEL_YN = 'N'
		   AND sqp.DEL_YN = 'N'
	</select>

</mapper>
